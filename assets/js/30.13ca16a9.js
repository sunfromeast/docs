(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{248:function(s,e,n){"use strict";n.r(e);var t=n(0),a=Object(t.a)({},function(){var s=this,e=s.$createElement,n=s._self._c||e;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"客户端配置文件kubeconfig"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#客户端配置文件kubeconfig","aria-hidden":"true"}},[s._v("#")]),s._v(" 客户端配置文件kubeconfig")]),s._v(" "),n("p",[s._v("kubeconfig配置文件提供了接入多个集群的相关配置信息（包括：各个集群、各个用户、各个上下文）。")]),s._v(" "),n("p",[s._v("使用kubeadm初始化集群后生成的"),n("code",[s._v("/etc/kubernetes/admin.conf")]),s._v("即为kubeconfig格式的配置文件，其由kubeadm init命令自动生成，可以由kubectl加载（默认路径$HOME/.kube/config）后用于接入服务器。")]),s._v(" "),n("p",[n("code",[s._v("kubectl config")]),s._v("命令常用操作：")]),s._v(" "),n("div",{staticClass:"language-markdown line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-markdown"}},[n("code",[n("span",{pre:!0,attrs:{class:"token title important"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("#")]),s._v(" 1 显示kubeconfig文件的信息")]),s._v("\nkubectl config view \n\n"),n("span",{pre:!0,attrs:{class:"token title important"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("#")]),s._v(" 2 设置cluster")]),s._v("\nkubectl config set-cluster ...\n\n"),n("span",{pre:!0,attrs:{class:"token title important"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("#")]),s._v(" 3 设置user")]),s._v("\nkubectl config set-credentials ...\n\n"),n("span",{pre:!0,attrs:{class:"token title important"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("#")]),s._v(" 4 设置上下文")]),s._v("\nkubectl config set-context ...\n\n"),n("span",{pre:!0,attrs:{class:"token title important"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("#")]),s._v(" 5 使用指定上下文")]),s._v("\nkubectl config use-context ...\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("显示当前kubeconfig如下：")]),s._v(" "),n("div",{staticClass:"language-markdown line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-markdown"}},[n("code",[s._v("apiVersion: v1\nclusters:\n"),n("span",{pre:!0,attrs:{class:"token list punctuation"}},[s._v("-")]),s._v(" cluster:\n    certificate-authority-data: DATA+OMITTED\n    server: https://192.168.144.3:6443\n  name: kubernetes\ncontexts:\n"),n("span",{pre:!0,attrs:{class:"token list punctuation"}},[s._v("-")]),s._v(" context:\n    cluster: kubernetes\n    user: kubernetes-admin\n  name: kubernetes-admin@kubernetes\ncurrent-context: kubernetes-admin@kubernetes\nkind: Config\npreferences: {}\nusers:\n"),n("span",{pre:!0,attrs:{class:"token list punctuation"}},[s._v("-")]),s._v(" name: kubernetes-admin\n  user:\n    client-certificate-data: REDACTED\n    client-key-data: REDACTED\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("blockquote",[n("p",[s._v("其中：")]),s._v(" "),n("p",[s._v("-clusters：集群列表，包含访问APIServer的URL和集群名称。")]),s._v(" "),n("p",[s._v("-users：用户列表，包含访问APIServer时的用户名和认证信息。")]),s._v(" "),n("p",[s._v("-context：kubelet可用的上下文列表，由cluster和user组合而成。")]),s._v(" "),n("p",[s._v("current-context：当前使用的上下文")])]),s._v(" "),n("h2",{attrs:{id:"测试kubeconfig"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#测试kubeconfig","aria-hidden":"true"}},[s._v("#")]),s._v(" 测试kubeconfig")]),s._v(" "),n("p",[s._v("测试过程：新建一个用户kube-user1，然后，将该用户和默认集群kubernetes管联。")]),s._v(" "),n("p",[n("font",{attrs:{color:"red"}},[s._v("所有操作在master节点进行")])],1),s._v(" "),n("h3",{attrs:{id:"生成私钥和证书"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#生成私钥和证书","aria-hidden":"true"}},[s._v("#")]),s._v(" 生成私钥和证书")]),s._v(" "),n("div",{staticClass:"language-markdown line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-markdown"}},[n("code",[s._v(" cd /etc/kubernetes/pki\n\n"),n("span",{pre:!0,attrs:{class:"token title important"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("#")]),s._v(" 生成证书")]),s._v('\nopenssl genrsa -out kube-user1.key 2048\n\nopensll req -new -in kube-user1.key -out kube-user1.csr -subj "/CN=kube-user1/O=kubernetes"\n\nopenssl x509 -req -in kube-user1.csr -CA ca.crt -CAkey ca.key \\\n-CAcreateserial -out kube-user1.crt -days 3650\n\n'),n("span",{pre:!0,attrs:{class:"token title important"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("#")]),s._v(" 验证证书")]),s._v("\nopenssl x509 -in kube-user1.crt -text -noout\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("h3",{attrs:{id:"创建集群、用户、上下文"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建集群、用户、上下文","aria-hidden":"true"}},[s._v("#")]),s._v(" 创建集群、用户、上下文")]),s._v(" "),n("div",{staticClass:"language-markdown line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-markdown"}},[n("code",[n("span",{pre:!0,attrs:{class:"token title important"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("#")]),s._v(" 创建集群，已经存在，可以省略这一步")]),s._v('\nkubectl config set-cluster kubernetes --embed-certs=true \\\n--certificate-authority=/etc/kubernetess/pki/ca.crt \\\n--server="https://192.168.144.3:6443"\n\n'),n("span",{pre:!0,attrs:{class:"token title important"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("#")]),s._v(" 创建用户")]),s._v("\nkubectl config set-credentials kube-user1 --embed-certs=true \\\n--client-certificate=/etc/kubernetes/pki/kube-user1.crt \\\n--client-key=/etc/kubernetes/pki/kube-user1.key\n\n"),n("span",{pre:!0,attrs:{class:"token title important"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("#")]),s._v(" 配置context")]),s._v("\nkubectl config set-context kube-user1@kubernetes --cluster=kubernetes --user=kube-user1\n\n"),n("span",{pre:!0,attrs:{class:"token title important"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("#")]),s._v(" 指定要使用的上下文")]),s._v("\nkubectl config use-context kube-user1@kubernetes\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("blockquote",[n("ul",[n("li",[s._v("由于此时的用户kube-user1没有被授权，所以，访问集群资源会报错。")]),s._v(" "),n("li",[s._v("如果需要临时使用某个context，不必切换context，只需在kubectl命令使用--context选项指定目标context即可。")])])]),s._v(" "),n("p",[s._v("给kube-user1绑定角色授权，使其可以访问集群资源")]),s._v(" "),n("div",{staticClass:"language-markdown line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-markdown"}},[n("code",[n("span",{pre:!0,attrs:{class:"token title important"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("#")]),s._v(" 先切换kubernetes-admin@kubernetes")]),s._v("\nkubectl config use-context kubernetes-admin@kubernetes\n\n"),n("span",{pre:!0,attrs:{class:"token title important"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("#")]),s._v(" 创建一个角色，可以访问service")]),s._v('\nkubectl create role services-admin --resource="services" \\\n--verb="*"\n\n'),n("span",{pre:!0,attrs:{class:"token title important"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("#")]),s._v(" 给kube-user1绑定角色进行授权")]),s._v("\nkubectl create rolebinding kubeuser1-rb --user=kube-user1 --role=services-admin\n\n"),n("span",{pre:!0,attrs:{class:"token title important"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("#")]),s._v(" 测试访问")]),s._v("\nkubectl get svc --context=kube-user1@kubernetes\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])])])},[],!1,null,null,null);e.default=a.exports}}]);