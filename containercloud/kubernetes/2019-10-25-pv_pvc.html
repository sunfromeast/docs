<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>PV | YGTAO</title>
    <meta name="description" content="非学无以广才，非志无以成学">
    
    
    <link rel="preload" href="/docs/assets/css/0.styles.430309d1.css" as="style"><link rel="preload" href="/docs/assets/js/app.98b1b838.js" as="script"><link rel="preload" href="/docs/assets/js/2.fbd0f029.js" as="script"><link rel="preload" href="/docs/assets/js/25.3cf34719.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.7e9ca6bf.js"><link rel="prefetch" href="/docs/assets/js/11.e4324770.js"><link rel="prefetch" href="/docs/assets/js/12.d1b931cd.js"><link rel="prefetch" href="/docs/assets/js/13.e3913e7d.js"><link rel="prefetch" href="/docs/assets/js/14.481621c4.js"><link rel="prefetch" href="/docs/assets/js/15.1be8de18.js"><link rel="prefetch" href="/docs/assets/js/16.3e052bc3.js"><link rel="prefetch" href="/docs/assets/js/17.90812fdd.js"><link rel="prefetch" href="/docs/assets/js/18.051948c5.js"><link rel="prefetch" href="/docs/assets/js/19.a628549a.js"><link rel="prefetch" href="/docs/assets/js/20.47ca6f8b.js"><link rel="prefetch" href="/docs/assets/js/21.4987dc80.js"><link rel="prefetch" href="/docs/assets/js/22.277c3ac0.js"><link rel="prefetch" href="/docs/assets/js/23.8f1d3525.js"><link rel="prefetch" href="/docs/assets/js/24.58c831bf.js"><link rel="prefetch" href="/docs/assets/js/26.29504454.js"><link rel="prefetch" href="/docs/assets/js/27.0283fa1f.js"><link rel="prefetch" href="/docs/assets/js/28.d9581f85.js"><link rel="prefetch" href="/docs/assets/js/29.bd14f7a0.js"><link rel="prefetch" href="/docs/assets/js/3.685d3d93.js"><link rel="prefetch" href="/docs/assets/js/30.13ca16a9.js"><link rel="prefetch" href="/docs/assets/js/31.b60cff58.js"><link rel="prefetch" href="/docs/assets/js/32.8224a326.js"><link rel="prefetch" href="/docs/assets/js/33.329ea19d.js"><link rel="prefetch" href="/docs/assets/js/34.0643ae8a.js"><link rel="prefetch" href="/docs/assets/js/35.f423a121.js"><link rel="prefetch" href="/docs/assets/js/36.e1ab1f2e.js"><link rel="prefetch" href="/docs/assets/js/37.e46bd7b3.js"><link rel="prefetch" href="/docs/assets/js/38.810db745.js"><link rel="prefetch" href="/docs/assets/js/39.7f03ade6.js"><link rel="prefetch" href="/docs/assets/js/4.b33a4828.js"><link rel="prefetch" href="/docs/assets/js/40.6d65eeea.js"><link rel="prefetch" href="/docs/assets/js/41.e5d2db89.js"><link rel="prefetch" href="/docs/assets/js/42.0618af06.js"><link rel="prefetch" href="/docs/assets/js/43.feddb362.js"><link rel="prefetch" href="/docs/assets/js/44.7e8f1637.js"><link rel="prefetch" href="/docs/assets/js/45.60a8cb44.js"><link rel="prefetch" href="/docs/assets/js/46.5969b6a6.js"><link rel="prefetch" href="/docs/assets/js/47.8d42c32f.js"><link rel="prefetch" href="/docs/assets/js/48.6d5a4798.js"><link rel="prefetch" href="/docs/assets/js/49.33bdd943.js"><link rel="prefetch" href="/docs/assets/js/5.6c13e633.js"><link rel="prefetch" href="/docs/assets/js/50.ad999b46.js"><link rel="prefetch" href="/docs/assets/js/51.696fe0f8.js"><link rel="prefetch" href="/docs/assets/js/52.dc345021.js"><link rel="prefetch" href="/docs/assets/js/53.0ff3d1fa.js"><link rel="prefetch" href="/docs/assets/js/54.f2a30034.js"><link rel="prefetch" href="/docs/assets/js/55.9a115f86.js"><link rel="prefetch" href="/docs/assets/js/56.fc5f8a21.js"><link rel="prefetch" href="/docs/assets/js/57.72313323.js"><link rel="prefetch" href="/docs/assets/js/6.4941188b.js"><link rel="prefetch" href="/docs/assets/js/7.4e14eb19.js"><link rel="prefetch" href="/docs/assets/js/8.b2d53e98.js"><link rel="prefetch" href="/docs/assets/js/9.a766f1bb.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.430309d1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">YGTAO</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Java相关</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/docs/java/javabase/" class="nav-link">Java基础</a></li><li class="dropdown-subitem"><a href="/docs/java/spring/" class="nav-link">Spring</a></li><li class="dropdown-subitem"><a href="/docs/java/springboot/" class="nav-link">SpringBoot</a></li><li class="dropdown-subitem"><a href="/docs/java/springcloud/" class="nav-link">SpringCloud</a></li></ul></li><li class="dropdown-item"><h4>进阶</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/docs/containercloud/kubernetes/.html" class="nav-link">Java虚拟机</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Linux相关</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/linux/linuxbase/" class="nav-link">Linux基础</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">容器云相关</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Kubernetes相关</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/docs/containercloud/docker/" class="nav-link">Docker</a></li><li class="dropdown-subitem"><a href="/docs/containercloud/kubernetes/" class="nav-link router-link-active">Kubernetes</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/docs/frontend/" class="nav-link">前端相关</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">源码</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/sourcecode/springboot/" class="nav-link">SpringBoot源码</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/tools/vuepress/" class="nav-link">vuepress使用</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/others/offer/" class="nav-link">剑指offer</a></li></ul></div></div> <a href="https://github.com/sunfromeast/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Java相关</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/docs/java/javabase/" class="nav-link">Java基础</a></li><li class="dropdown-subitem"><a href="/docs/java/spring/" class="nav-link">Spring</a></li><li class="dropdown-subitem"><a href="/docs/java/springboot/" class="nav-link">SpringBoot</a></li><li class="dropdown-subitem"><a href="/docs/java/springcloud/" class="nav-link">SpringCloud</a></li></ul></li><li class="dropdown-item"><h4>进阶</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/docs/containercloud/kubernetes/.html" class="nav-link">Java虚拟机</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Linux相关</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/linux/linuxbase/" class="nav-link">Linux基础</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">容器云相关</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Kubernetes相关</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/docs/containercloud/docker/" class="nav-link">Docker</a></li><li class="dropdown-subitem"><a href="/docs/containercloud/kubernetes/" class="nav-link router-link-active">Kubernetes</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/docs/frontend/" class="nav-link">前端相关</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">源码</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/sourcecode/springboot/" class="nav-link">SpringBoot源码</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/tools/vuepress/" class="nav-link">vuepress使用</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/others/offer/" class="nav-link">剑指offer</a></li></ul></div></div> <a href="https://github.com/sunfromeast/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/docs/containercloud/kubernetes/" class="sidebar-link">前言</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础介绍</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>部署指南</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>资源对象</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>资源管理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>服务发现</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>存储卷和数据持久化</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/containercloud/kubernetes/2019-10-25-pv_pvc.html" class="active sidebar-link">PV和PVC</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/containercloud/kubernetes/2019-10-25-pv_pvc.html#pv" class="sidebar-link">PV</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/containercloud/kubernetes/2019-10-25-pv_pvc.html#概述" class="sidebar-link">概述</a></li><li class="sidebar-sub-header"><a href="/docs/containercloud/kubernetes/2019-10-25-pv_pvc.html#原理" class="sidebar-link">原理</a></li><li class="sidebar-sub-header"><a href="/docs/containercloud/kubernetes/2019-10-25-pv_pvc.html#参考" class="sidebar-link">参考</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/containercloud/kubernetes/2019-10-25-pv_pvc.html#pvc" class="sidebar-link">PVC</a></li><li class="sidebar-sub-header"><a href="/docs/containercloud/kubernetes/2019-10-25-pv_pvc.html#pv和pvc生命周期" class="sidebar-link">PV和PVC生命周期</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/containercloud/kubernetes/2019-10-25-pv_pvc.html#资源供应" class="sidebar-link">资源供应</a></li><li class="sidebar-sub-header"><a href="/docs/containercloud/kubernetes/2019-10-25-pv_pvc.html#资源绑定" class="sidebar-link">资源绑定</a></li><li class="sidebar-sub-header"><a href="/docs/containercloud/kubernetes/2019-10-25-pv_pvc.html#资源使用" class="sidebar-link">资源使用</a></li><li class="sidebar-sub-header"><a href="/docs/containercloud/kubernetes/2019-10-25-pv_pvc.html#资源释放" class="sidebar-link">资源释放</a></li><li class="sidebar-sub-header"><a href="/docs/containercloud/kubernetes/2019-10-25-pv_pvc.html#资源回收" class="sidebar-link">资源回收</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/containercloud/kubernetes/2019-10-25-pv_pvc.html#storageclass" class="sidebar-link">StorageClass</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/containercloud/kubernetes/2019-10-25-pv_pvc.html#参考-2" class="sidebar-link">参考</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/containercloud/kubernetes/2019-10-25-pv_pvc.html#volumeclaimtemplates" class="sidebar-link">volumeClaimTemplates</a></li><li class="sidebar-sub-header"><a href="/docs/containercloud/kubernetes/2019-10-25-pv_pvc.html#subpath" class="sidebar-link">subPath</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>认证授权与准入控制</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>网络模型和策略</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他组件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Helm包管理器</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="pv"><a href="#pv" aria-hidden="true" class="header-anchor">#</a> PV</h2> <h3 id="概述"><a href="#概述" aria-hidden="true" class="header-anchor">#</a> 概述</h3> <ul><li>PV是一种“资源”，是对底层网络共享存储的抽象。它定义了一个持久化存储在宿主机上的目录。</li> <li>作为资源，包括：
<ul><li>存储能力（capacity）：当前仅支持对存储空间的设置（storage=xx）</li> <li>访问模式（accessModes）
<ul><li>ReadWriteOnce（RWO）：读写权限，能被单个node挂载</li> <li>ReadOnlyMany（ROX）：只读权限，允许被多个node挂载</li> <li>ReadWriteMany（RWX）：读写权限，允许被多个node挂载</li> <li>存储类型（Class)：设置存储的类别。通过<code>storageClassName</code>参数指定一个<code>StorageClass</code>资源对象名称。具有特定类别的PV只能与请求了该类别的PVC进行绑定。未设置类别的PV只能与不请求任何类别的PVC进行绑定。</li></ul></li> <li>回收策略（persistentVolumeReclaimPolicy）
<ul><li>保留（Retain）：保留数据，手工处理</li> <li>回收空间（Recycle）：简单清除文件操作</li> <li>删除（Delete）：与PV关联的后盾存储完成volume的删除工作。</li></ul></li> <li>后端存储类型</li></ul></li> <li>生命周期各个阶段
<ul><li>Available：可用</li> <li>Bound：已绑定PVC</li> <li>Released：绑定的PVC删除，资源以释放、</li> <li>Failed：自动资源回收失败</li></ul></li> <li>PV挂载参数（Mount Options）
<ul><li>PV挂载到Node上时，根据后端存储特点，可能需要设置额外的挂载参数。目前可以通过在PV的定义中设置一个名为<code>volume.beta.kubernetes.io/mount-options</code>的annotation来实现。</li></ul></li></ul> <p>示例：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv0003
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi
  <span class="token key atrule">volumeMode</span><span class="token punctuation">:</span> Filesystem
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Recycle
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> slow
  <span class="token key atrule">mountOptions</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> hard
    <span class="token punctuation">-</span> nfsvers=4.1
  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /tmp
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 172.17.0.2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="原理"><a href="#原理" aria-hidden="true" class="header-anchor">#</a> 原理</h3> <p><font color="red">pv对象怎么变成容器中的持久化存储？</font></p> <blockquote><p>持久化volume需要满足两个条件：</p> <ul><li>容器删除，持久化volume不会删除</li> <li>容器重建，绑定的还是之前的volume</li></ul></blockquote> <p>持久化宿主机目录的过程，分为两个阶段：</p> <p>阶段1：Attach</p> <blockquote><p>pod调度到某个节点，kubelet负责为这个Pod创建它的Volume，默认情况下，kubelet创建的Volume在宿主机上的目录为：</p> <div class="language-markdown line-numbers-mode"><pre class="language-markdown"><code>/var/lib/kubelet/pods/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Pod的ID</span><span class="token punctuation">&gt;</span></span>/volumes/kubernetes.io~<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Volume类型</span><span class="token punctuation">&gt;</span></span>/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Volume名字</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></blockquote> <p>阶段2：Mount</p> <blockquote><p>将远程存储服务器目录挂载到Volume的宿主机目录上。这样，你在宿主机目录写入的所有文件，都会保存到远程存储服务目录上。</p> <p>这个过程由VolumeManagerReconciler控制，它允许起来后，是一个独立于kubelet主循环的Coroutine。</p></blockquote> <p>经过两个阶段的处理，就得到了一个持久化的Volume的宿主机目录，接下来，kubelet就把这个Volume目录通过CRI里的Mounts参数，传递给Docker，然后，就可以为Pod中的容器挂载这个持久化的Volume了。</p> <blockquote><p>另外，volume的处理流程和Pod及容器的请求流程没有太多的耦合，只要kubelet在向CRI发请求之前，确保持久化目录准备好了。</p></blockquote> <h3 id="参考"><a href="#参考" aria-hidden="true" class="header-anchor">#</a> 参考</h3> <ul><li><a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/" target="_blank" rel="noopener noreferrer">官网-PV<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="pvc"><a href="#pvc" aria-hidden="true" class="header-anchor">#</a> PVC</h2> <p>PVC是用户对存储资源的需求申请。它描述的是Pod所希望使用的持久化存储的属性。主要包括：</p> <ul><li><p>资源请求（Resources）</p> <ul><li>目前仅支持<code>request.storage</code>的设置，即存储空间大小</li></ul></li> <li><p>访问模式（Access Modes）</p> <ul><li>描述用户对存储资源的访问权限</li></ul></li> <li><p>PV选择条件（Selector）</p> <ul><li>通过Label Selector的设置，是PVC对系统中已存在的PV进行筛选，系统将根据标签选择出合适的PV与PVC进行绑定。</li> <li>选择条件：使用<code>matchLabels</code>和<code>matchExpressions</code>进行设置</li></ul></li> <li><p>存储类别（Class）</p> <ul><li><p>设置需要的后端存储类别（通过storageClassName字段指定）</p></li> <li><p>你也可以设定为空，这时系统会选取未设定Class的PV与之绑定。</p></li> <li><p>你也可以不指定。系统会根据是否启用<code>DefaultStorageClass</code>的admission controller进行相应操作</p> <ul><li><p>未启用。等效<code>stoageClassName = &quot;&quot;</code></p></li> <li><p>以启用。需要管理员已定义默认StorageClass，</p> <ul><li>如果不存在，等效未启用。</li> <li>如果存在，系统将自动为PVC创建御姐PV（使用默认StorageClass的后端存储），并将它们进行绑定。</li></ul></li> <li><p>设置默认StorageClass方法。</p> <ul><li><p>在StorageClass的定义中加annotation：</p> <p><code>storageclass.kubernetes.io/is-default-class=true</code></p></li> <li><p>默认存储类只能创建一个。</p></li></ul></li></ul></li></ul></li></ul> <h2 id="pv和pvc生命周期"><a href="#pv和pvc生命周期" aria-hidden="true" class="header-anchor">#</a> PV和PVC生命周期</h2> <h3 id="资源供应"><a href="#资源供应" aria-hidden="true" class="header-anchor">#</a> 资源供应</h3> <p>两种资源供应模式：静态模式（Static）和动态模式（Dynamic），资源供应的结果就是创建好的PV</p> <ul><li>静态模式：管理员手工创建许多PV，定义PV时将后端存储的特性进行设置</li> <li>动态模式：无需手工创建PV。而是通过StorageClass的设置对后端存储进行描述，标记为某种“类型”，此时要求PVC对存储的类型进行声明，系统自动完成PV的创建和PVC的绑定。PVC可以声明class为“”，说明PVC禁止使用动态模式。</li></ul> <h3 id="资源绑定"><a href="#资源绑定" aria-hidden="true" class="header-anchor">#</a> 资源绑定</h3> <p>用户定义好PVC后，系统根据PVC对资源的请求，去寻找满足要求的PV。</p> <ul><li>一旦找到，就将PV与用户定义的PVC绑定。PV被PVC独占，不能再被其他PVC绑定，此种情况下，可能造成PV资源的浪费。</li> <li>没有找到，PVC无限期处于Pending状态，直到等到系统管理员创建了一个符合要求的PV。</li></ul> <h3 id="资源使用"><a href="#资源使用" aria-hidden="true" class="header-anchor">#</a> 资源使用</h3> <p>pod使用volume的定义，将PVC挂载到容器内的某个路径进行使用。volume的类型<code>persistentVolumeClaim</code>。多个pod可以挂载同一个PVC，应用程序需要考虑多个实例访问一块存储空间的问题。</p> <h3 id="资源释放"><a href="#资源释放" aria-hidden="true" class="header-anchor">#</a> 资源释放</h3> <p>用户使用完存储资源后，用户可以删除PVC，与该PVC绑定的PV将会被标记为“已释放”，但还不能立刻与其他PVC进行绑定，因为之前PVC的数据还留在存储设备上，只有清除之后该PV才能再次使用。</p> <h3 id="资源回收"><a href="#资源回收" aria-hidden="true" class="header-anchor">#</a> 资源回收</h3> <p>对于PV，管理员可以设置回收策略（Reclaim Policy），用于设置与之绑定的PVC释放资源之后，遗留数据如何处理，只有PV的存储空间完成回收，才能供新的PVC绑定和使用。</p> <h2 id="storageclass"><a href="#storageclass" aria-hidden="true" class="header-anchor">#</a> StorageClass</h2> <p>StorageClass：对存储资源的抽象定义。对用户的PVC屏蔽后端存储的细节。一方面减轻用户对存储资源细节的关注，另一方面，减轻管理员手工管理PV的工作。由系统自动完成PV的创建和绑定，实现了动态的资源供应。</p> <p>StorageClass定义：</p> <ul><li>后端存储提供者（Provisioner）</li> <li>后端存储相关参数</li></ul> <p>**注意：**StorageClass一旦创建出来，无法修改，如需修改，只能删除原StorageClass定义。</p> <p>示例：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> standard
<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> kubernetes.io/aws<span class="token punctuation">-</span>ebs
<span class="token key atrule">parameters</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> gp2
<span class="token key atrule">reclaimPolicy</span><span class="token punctuation">:</span> Retain
<span class="token key atrule">mountOptions</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> debug
<span class="token key atrule">volumeBindingMode</span><span class="token punctuation">:</span> Immediate
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li><p>设置默认StorageClass</p> <ul><li><p>首先启用<code>DefaultStorageClass</code>的admission controller，即：在kube-apiserver的命令行参数</p> <p><code>--adminission-control</code>中添加：</p> <p><code>--adminission-control=..., DefaultStorageClass</code></p> <p>然后，在StorageClass定义中设置annotation：</p> <p><code>stoageclass.beta.kubernetes.io/is-default-class=&quot;true&quot;</code></p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment"># 修改默认storageclass，参考官网</span>
<span class="token attr-name">kubectl</span> <span class="token attr-value">patch storageclass &lt;your-class-name&gt; -p '{&quot;metadata&quot;: {&quot;annotations&quot;:{&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;}}}'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ul></li></ul> <h3 id="参考-2"><a href="#参考-2" aria-hidden="true" class="header-anchor">#</a> 参考</h3> <ul><li><a href="https://kubernetes.io/docs/concepts/storage/storage-classes/" target="_blank" rel="noopener noreferrer">官网-StorageClass<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.jianshu.com/p/b5fb31424c09" target="_blank" rel="noopener noreferrer">Ceph在Kubernetes中的一些应用<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://kubernetes.io/docs/tasks/administer-cluster/change-default-storage-class/" target="_blank" rel="noopener noreferrer">官网-Change the default StorageClass<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="volumeclaimtemplates"><a href="#volumeclaimtemplates" aria-hidden="true" class="header-anchor">#</a> volumeClaimTemplates</h2> <ul><li><p>作用：容器在使用volumes的时候，动态创建和映射容器与PVC的关系。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>	<span class="token punctuation">...</span>
	<span class="token key atrule">spec</span><span class="token punctuation">:</span>
	<span class="token punctuation">...</span>
	<span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> rabbitmq<span class="token punctuation">-</span>data<span class="token punctuation">-</span>pvc
        <span class="token key atrule">annotations</span><span class="token punctuation">:</span> 
          <span class="token key atrule">volume.beta.kubernetes.io/storage-class</span><span class="token punctuation">:</span> &quot;ceph<span class="token punctuation">-</span>storageclass&quot; //和下面的配置二选一
      <span class="token key atrule">spec</span><span class="token punctuation">:</span>
        <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;ReadWriteOnce&quot;</span><span class="token punctuation">]</span>
        <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> <span class="token string">&quot;ceph-storageclass&quot;</span>
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">storage</span><span class="token punctuation">:</span> 50Gi

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li></ul> <h2 id="subpath"><a href="#subpath" aria-hidden="true" class="header-anchor">#</a> subPath</h2> <ul><li><p>作用：有时，可以在一个pod中，将同一个卷共享，使其有多个用处。volumeMounts.subPath特性可以用来指定卷中的一个子目录，而不是直接使用卷的根目录。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>lamp<span class="token punctuation">-</span>site
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
    <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
      <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql
      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/mysql
        <span class="token key atrule">name</span><span class="token punctuation">:</span> site<span class="token punctuation">-</span>data
        <span class="token key atrule">subPath</span><span class="token punctuation">:</span> mysql
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> php
      <span class="token key atrule">image</span><span class="token punctuation">:</span> php
      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/www/html
        <span class="token key atrule">name</span><span class="token punctuation">:</span> site<span class="token punctuation">-</span>data
        <span class="token key atrule">subPath</span><span class="token punctuation">:</span> html
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> site<span class="token punctuation">-</span>data
      <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
        <span class="token key atrule">claimName</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>lamp<span class="token punctuation">-</span>site<span class="token punctuation">-</span>data
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><blockquote><p>个人理解：共享一个卷的时候，需要在卷中建立多个子目录以区分，而subPath就是在卷中指定子目录。</p></blockquote></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/sunfromeast/docs/edit/master/docs/containercloud/kubernetes/2019-10-25-pv_pvc.md" target="_blank" rel="noopener noreferrer">编辑文档</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2020-6-9 10:04:27 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/docs/containercloud/kubernetes/2019-9-2-资源管理基础.html" class="prev">
          基础
        </a></span> <span class="next"><a href="/docs/containercloud/kubernetes/2019-9-1-访问控制概述.html">
          概述
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/docs/assets/js/app.98b1b838.js" defer></script><script src="/docs/assets/js/2.fbd0f029.js" defer></script><script src="/docs/assets/js/25.3cf34719.js" defer></script>
  </body>
</html>
